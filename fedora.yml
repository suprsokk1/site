# -*- mode: yaml -*-
# TODO .mozilla/.../chrome/userChrome.css
---
- hosts: all
  gather_facts: yes
  connection: local
  # delegate_to: localhost
  become_user: root
  tasks:
    - ansible.builtin.dnf: name=cargo,python3-jmespath state=installed
      become: yes


    - name: Galaxy collections
      become: no
      when: no
      block:
      - ignore_errors: yes
        shell: >-
          ansible-galaxy
          collection
          install
          {{_collections|json_query('name')}}
      rescue:
      - ignore_errors: yes
        shell: >-
          ansible-galaxy
          collection
          install
          sivel.toiletwater

    # - ansible.builtin.wait_for:
    #   when" "
    #     delay: 10
    #   connection: local


  vars:
    _collections:
    - name: sivel.toiletwater
    # - name: amazon.aws
    # - name: ansible.builtin
    - name: ansible.netcommon
    - name: ansible.posix
    - name: ansible.utils
    # - name: ansible.windows
    # - name: arista.eos
    # - name: awx.awx
    # - name: azure.azcollection
    # - name: check_point.mgmt
    # - name: chocolatey.chocolatey
    # - name: cisco.aci
    # - name: cisco.asa
    # - name: cisco.dnac
    # - name: cisco.intersight
    # - name: cisco.ios
    # - name: cisco.iosxr
    # - name: cisco.ise
    # - name: cisco.meraki
    # - name: cisco.mso
    # - name: cisco.nso
    # - name: cisco.nxos
    # - name: cisco.ucs
    - name: cloud.common
    # - name: cloudscale_ch.cloud
    # - name: community.aws
    - name: community.azure
    # - name: community.ciscosmb
    # - name: community.crypto
    - name: community.digitalocean
    - name: community.dns
    - name: community.docker
    # - name: community.fortios
    - name: community.general
    - name: community.google
    # - name: community.grafana
    # - name: community.hashi_vault
    # - name: community.hrobot
    - name: community.libvirt
    # - name: community.mongodb
    # - name: community.mysql
    - name: community.network
    # - name: community.okd
    # - name: community.postgresql
    # - name: community.proxysql
    # - name: community.rabbitmq
    # - name: community.routeros
    # - name: community.sap
    # - name: community.sap_libs
    # - name: community.skydive
    # - name: community.sops
    # - name: community.vmware
    # - name: community.windows
    # - name: community.zabbix
    # - name: containers.podman
    # - name: cyberark.conjur
    # - name: cyberark.pas
    # - name: dellemc.enterprise_sonic
    # - name: dellemc.openmanage
    # - name: dellemc.powerflex
    # - name: dellemc.unity
    # - name: f5networks.f5_modules
    # - name: fortinet.fortimanager
    # - name: fortinet.fortios
    # - name: frr.frr
    # - name: gluster.gluster
    # - name: google.cloud
    # - name: grafana.grafana
    # - name: hetzner.hcloud
    # - name: hpe.nimble
    # - name: ibm.qradar
    # - name: ibm.spectrum_virtualize
    # - name: infinidat.infinibox
    # - name: infoblox.nios_modules
    # - name: inspur.ispim
    # - name: inspur.sm
    # - name: junipernetworks.junos
    - name: kubernetes.core
    # - name: lowlydba.sqlserver
    # - name: microsoft.ad
    # - name: netapp.aws
    # - name: netapp.azure
    # - name: netapp.cloudmanager
    # - name: netapp.elementsw
    # - name: netapp_eseries.santricity
    # - name: netapp.ontap
    # - name: netapp.storagegrid
    # - name: netapp.um_info
    # - name: netbox.netbox
    # - name: ngine_io.cloudstack
    # - name: ngine_io.exoscale
    # - name: ngine_io.vultr
    # - name: openstack.cloud
    # - name: openvswitch.openvswitch
    # - name: ovirt.ovirt
    # - name: purestorage.flasharray
    # - name: purestorage.flashblade
    # - name: purestorage.fusion
    # - name: sensu.sensu_go
    # - name: servicenow.servicenow
    # - name: splunk.es
    # - name: telekom_mms.icinga_director
    - name: theforeman.foreman
    # - name: t_systems_mms.icinga_director
    # - name: vmware.vmware_rest
    # - name: vultr.cloud
    # - name: vyos.vyos
    # - name: wti.remote


- hosts: all
  # no_log: yes
  connection: local
  gather_facts: yes
  become: no
  environment:

    # inhibit playbook lockup
    GIT_TERMINAL_PROMPT: 0

    # review safe for other packages?
    CARGO_FEATURE_PCRE2: 1


  post_tasks:

    - when: true
      tags: always
      debug:
        msg: >-
          {{ items|json_query('[?zsh_plugin].name')|join(' ') }}

    - name: todo
      meta: noop
      vars:
        b: &become
          become: yes
          become_user: root
        c: &common
          register: res
          when: res is successfull

  tasks:

    - name: catppuccin / zsh-users
      tags: git catppuccin
      with_dict: "{{git_repos}}"
      loop_control:
        loop_var: x
      git: dest={{x.key}} repo={{x.value}}

    - name: >-
        install ripgrep with pcre2 enabled
      when: COMMENT
      community.general.cargo:
        name: ripgrep
        state: present
      environment:
        CARGO_FEATURE_PCRE2: 1

    - name: >-
        install packages
      rescue:
        - meta: noop
      block:
        - community.general.cargo:
            state: present
            name: "{{ items|json_query('[?crate].name')|default(omit) }}"

        - community.general.pipx:
            state: present
            name: "{{ items|json_query('[?egg].name')|default(omit)  }}"


    - service: name="{{item}}" state="started" enabled=yes
      become: yes
      loop: "{{ items|json_query('[?service].name')|default(omit) }}"

    - name: >-
        set default editor
      when: COMMENT
      loop_control:
        extended: true
        loop_var: line
      loop:
        - ""
        - "# default editor"
        - "editor=emacsclient"
        - "export editor"
      ansible.builtin.lineinfile:
        create: yes
        path: >-
          {{ansible_user_dir}}/.zshenv
        state: present
        insertafter: >-
          {{ansible_loop.previtem|default(omit)}}
        line: >-
          {{line}}
        validate: /bin/zsh -c 'source %s'

    - name: >-
        Dotfiles
      block:
        - name: Copies files to remote locations.
          copy: dest={{item.path}} mode=0640 content={{item.content}}
          with_items: "{{ items|json_query('[?zsh_plugins]') }}"

    - name: >-
        ~/.zshrc
      vars:
        plugins: "{{ items|json_query('[?zsh_plugin].name')|default(omit) }}"
      # when: COMMENT
      ansible.builtin.copy:
        backup: yes
        dest: >-
          {{ansible_user_dir}}/.zshrc
        content: |
          export ZSH="$home/.oh-my-zsh"
          ZSH_THEME="gentoo"
          DISABLE_UNTRACKED_FILES_DIRTY="true"

          FZF_DEFAULT_OPTS=' --multi --exact --bind '\''ctrl-s:toggle-all'\'' '; export fzf_default_opts

          plugins={{ items|json_query('[?zsh_plugin].name')|join(' ') }}
          source $ZSH/oh-my-zsh.sh

    - name: >-
        set host facts from a task
      set_fact:
        script_path: "{{ansible_user_dir}}/.script"

    - stat: path="{{script_path}}"
      register: script

    - file: path={{ansible_user_dir}}/.local/share/catppuccin state=directory recurse=yes


    # - name: >-
    #     add common paths to users zshenv
    #   loop_control:
    #     extended: true
    #     loop_var: path
    #   with_fileglob:
    #     - {{ansible_user_dir}}/*/bin
    #     - {{ansible_user_dir}}/.*/bin
    #     - {{ansible_user_dir}}/.local/share/pipx/venvs/*/bin
    #     - {{ansible_user_dir}}/.emacs.d/bin
    #     - {{ansible_user_dir}}/bin
    #   ansible.builtin.lineinfile:
    #     create: yes
    #     path: >-
    #       {{ansible_user_dir}}/.zshenv
    #     state: present
    #     insertafter: >-
    #       ^path+=({{ansible_loop.previtem|default(omit)}})
    #     line: >-
    #       path+=({{path}})
    #     validate: /bin/zsh -c source %s


  vars:
    __git_repos:
      com:
        github:
          catppuccin: [dunst,emacs,alacritty,sway,waybar]

    items:

      # - shell_alias:
      #     name: ls
      #     command: 'exa --group-directories-first --git --icons -lp'

      # - shell_alias:
      #     name: ls
      #     command: 'exa'

      - shell_alias:
          name: ls
          command: 'lsd'

      - statusbar_module:
          todo:

      - fzf:
          env: >-
            fzf_default_command='fd --type f --hidden --exclude .git'
            fzf_default_opts=' --reverse --exact --bind '\''ctrl-s:toggle-all'\'' --multi '

            fzf_lines           number of lines fzf takes up excluding padding and margin
            fzf_columns         number of columns fzf takes up excluding padding and margin
            fzf_total_count     total number of items
            fzf_match_count     number of matched items
            fzf_select_count    number of selected items
            fzf_pos             vertical position of the cursor in the list starting from 1
            fzf_query           current query string
            fzf_prompt          prompt string
            fzf_preview_label   preview label string
            fzf_border_label    border label string
            fzf_action          the name of the last action performed
            fzf_key             the name of the last key pressed
            fzf_port            port number when --listen option is used

            the following variables are additionally exported to the preview commands.

            fzf_preview_top     top position of the preview window
            fzf_preview_left    left position of the preview window
            fzf_preview_lines   number of lines in the preview window
            fzf_preview_columns number of columns in the preview window
      - service:
          name: ydotool

      - rpm:
          name: tldr
      - rpm:
          name: ydotool
      - rpm:
          name: networkmanager-tui
      - rpm:
          name: shellcheck
      - rpm:
          name: aajohan-comfortaa-fonts
      - rpm:
          name: alacritty
      - rpm:
          name: anaconda
      - rpm:
          name: anaconda-live
      - rpm:
          name: ansible
      - rpm:
          name: ansifilter
      - rpm:
          name: arm-image-installer
      - rpm:
          name: atk-devel
      - rpm:
          name: audispd-plugins
      - rpm:
          name: autoconf
      - rpm:
          name: blueman
      - rpm:
          name: borgbackup
      - rpm:
          name: brightnessctl
      - rpm:
          name: btop
      - rpm:
          name: cairo-devel
      - rpm:
          name: cargo
      - rpm:
          name: chromium
      - rpm:
          name: clang16-resource-filesystem
      - rpm:
          name: cmake
      - rpm:
          name: cronie
      - rpm:
          name: dbus-devel
      - rpm:
          name: ddgr
      - rpm:
          name: dialog
      - rpm:
          name: direnv
      - rpm:
          name: docker-compose
      - rpm:
          name: dracut-live
      - rpm:
          name: editorconfig
      - rpm:
          name: emacs
      - rpm:
          name: etckeeper
      - rpm:
          name: expect
      - rpm:
          name: fd-find
      - rpm:
          name: ffmpeg
      - rpm:
          name: fontconfig-devel
      - rpm:
          name: freerdp
      - rpm:
          name: freetype-devel
      - rpm:
          name: fswatch
      - rpm:
          name: fzf
      - rpm:
          name: gammastep
      - rpm:
          name: gh
      - rpm:
          name: ghostscript-tools-fonts
      - rpm:
          name: ghostscript-tools-printing
      - rpm:
          name: giflib-devel
      - rpm:
          name: git-delta
      - rpm:
          name: gnutls-devel
      - rpm:
          name: golang
      - rpm:
          name: gparted
      - rpm:
          name: gpm-devel
      - rpm:
          name: gron
      - rpm:
          name: gstreamer1-plugins-bad-free-extras
      - rpm:
          name: gstreamer1-plugins-bad-free-fluidsynth
      - rpm:
          name: gstreamer1-plugins-bad-free-opencv
      - rpm:
          name: gstreamer1-plugins-bad-free-wildmidi
      - rpm:
          name: gstreamer1-plugins-bad-free-zbar
      - rpm:
          name: gstreamer1-plugins-bad-freeworld
      - rpm:
          name: gstreamer1-plugins-good-extras
      - rpm:
          name: gtk3-devel
      - rpm:
          name: harfbuzz-devel
      - rpm:
          name: incron
      - rpm:
          name: intel-media-driver
      - rpm:
          name: jansson-devel
      - rpm:
          name: jc
      - rpm:
          name: jo
      - rpm:
          name: kitty
      - rpm:
          name: langpacks-en
      - rpm:
          name: libx11-devel
      - rpm:
          name: libxau-devel
      - rpm:
          name: libxdmcp-devel
      - rpm:
          name: libxi-devel
      - rpm:
          name: libxpm-devel
      - rpm:
          name: libxrender-devel
      - rpm:
          name: libxt-devel
      - rpm:
          name: libacl-devel
      - rpm:
          name: libgccjit-devel
      - rpm:
          name: libjpeg-turbo-devel
      - rpm:
          name: liblockfile-devel
      - rpm:
          name: libnsl
      - rpm:
          name: libotf-devel
      - rpm:
          name: libpng-devel
      - rpm:
          name: libreswan
      - rpm:
          name: librsvg2-devel
      - rpm:
          name: libselinux-devel
      - rpm:
          name: libsqlite3x-devel
      - rpm:
          name: libtiff-devel
      - rpm:
          name: libtree-sitter-devel
      - rpm:
          name: libva-intel-hybrid-driver
      - rpm:
          name: libva-utils
      - rpm:
          name: libwebp-devel
      - rpm:
          name: libxml2-devel
      - rpm:
          name: livesys-scripts
      - rpm:
          name: m17n-lib-devel
      - rpm:
          name: moby-engine
      - rpm:
          name: moreutils
      - rpm:
          name: ncurses-devel
      - rpm:
          name: nmap
      - rpm:
          name: nnn
      - rpm:
          name: nodejs
      - rpm:
          name: nodejs-bash-language-server
      - rpm:
          name: openscap
      - rpm:
          name: openscap-utils
      - rpm:
          name: openssh-askpass
      - rpm:
          name: pandoc
      - rpm:
          name: pass
      - rpm:
          name: pavucontrol
      - rpm:
          name: pinentry-emacs
      - rpm:
          name: pinentry-qt
      - rpm:
          name: pinentry-tty
      - rpm:
          name: pipx
      - rpm:
          name: powertop
      - rpm:
          name: python3-ansible-lint
      - rpm:
          name: python3-jmespath
      - rpm:
          name: python3-pip
      - rpm:
          name: python3-qrcode
      - rpm:
          name: qutebrowser
      - rpm:
          name: rclone
      - rpm:
          name: ripgrep
      - rpm:
          name: rofi-wayland
      - rpm:
          name: rpmfusion-free-release
      - rpm:
          name: rpmfusion-nonfree-release
      - rpm:
          name: scap-security-guide
      - rpm:
          name: scap-workbench
      - rpm:
          name: stow
      - rpm:
          name: systemd-devel
      - rpm:
          name: tailscale
      - rpm:
          name: texinfo
      - rpm:
          name: timeshift
      - rpm:
          name: tlp
      - rpm:
          name: tmux
      - rpm:
          name: vim-enhanced
      - rpm:
          name: webkit2gtk4.1-devel
      - rpm:
          name: wlsunset
      - rpm:
          name: xorg-x11-proto-devel
      - rpm:
          name: xz-lzma-compat
      - rpm:
          name: kitty
      - rpm:
          name: alacritty
      - rpm:
          name: zlib-ng-compat-devel
      - rpm:
          name: zsh

      - crate:
          name: grex
      - crate:
          name: fd-find
      - crate:
          name: zoxide
      - crate:
          name: git-delta
      - crate:
          name: lsd
      - crate:
          name: topgrade
      - crate:
          name: bat


      - rpm:
          name: qutebrowser
      - rpm:
          name: rclone
      - rpm:
          name: ripgrep
      - rpm:
          name: rofi-wayland
      - rpm:
          name: rpmfusion-free-release
      - rpm:
          name: rpmfusion-nonfree-release
      - rpm:
          name: scap-security-guide
      - rpm:
          name: scap-workbench
      - rpm:
          name: stow
      - rpm:
          name: systemd
      - rpm:
          name: tailscale
      - rpm:
          name: texinfo
      - rpm:
          name: timeshift
      - rpm:
          name: tlp
      - rpm:
          name: tmux
      - rpm:
          name: vim-enhanced
      - rpm:
          name: webkit2gtk4.1
      - rpm:
          name: wlsunset
      - rpm:
          name: ydotool
      - rpm:
          name: zlib-ng-compat
      - rpm:
          name: zsh

      - zsh_plugin:
          name: zsh-autosuggestions     # sourced at end of ~/.zshrc
          source: git
      - zsh_plugin:
          name: ansible
      - zsh_plugin:
          name: docker
      - zsh_plugin:
          name: emacs
      - zsh_plugin:
          name: emacs-cli
      - zsh_plugin:
          name: fd
      - zsh_plugin:
          name: fzf
      - zsh_plugin:
          name: gh
      - zsh_plugin:
          name: git
      - zsh_plugin:
          name: pass
      - zsh_plugin:
          name: ripgrep
      - zsh_plugin:
          name: ssh
      - zsh_plugin:
          name: ssh-agent
      - zsh_plugin:
          name: z
      - zsh_plugin:
          name: zoxide

      # - dotfile:
      #     content: |
      #       export zsh="$home/.oh-my-zsh"
      #       zsh_theme="gentoo"
      #       disable_untracked_files_dirty="true"

      #       fzf_default_opts=' --exact --bind '\''ctrl-s:toggle-all'\'' --multi '; export fzf_default_opts

      #       plugins={{ items|json_query('[?zsh_plugin]')|join(' ') }}
      #       source $ZSH/oh-my-zsh.sh

      - dotfile:
          name: waybar style.css
          path: ~/.config/waybar/style.css
          content: |
              @import "catppuccin/mocha.css";
              /* @import "catppuccin/themes/mocha.css"; */
              /* Use the colors in your Waybar style.css. Waybar uses GTK3 CSS. */

              * {
                  font-family: UbuntuSansMono Nerd Font Propo;
                  /* color: @text; */
                  /* color: @sapphire; */
                  /* color: @rosewater; */
                  /* color: @flamingo; */
                  /* color: @pink; */
                  /* color: @mauve; */
                  /* color: @red; */
                  /* color: @maroon; */
                  /* color: @peach; */
                  /* color: @yellow; */
                  /* color: @green; */
                  /* color: @teal; */
                  /* color: @sky; */
                  /* color: @sapphire; */
                  color: @blue;
                  /* color: @lavender; */
                  /* color: @text; */
                  /* color: @subtext1; */
                  /* color: @subtext0; */
                  /* color: @overlay2; */
                  /* color: @overlay1; */
                  /* color: @overlay0; */
                  /* color: @surface2; */
                  /* color: @surface1; */
                  /* color: @surface0; */
                  /* color: @base; */
                  /* color: @mantle; */
                  /* color: @crust; */

              }

      - dotfile:
          name: sway
          path: ~/.config/sway/config
          validate: 'sway --validate --config %s'
          content: |
            # -*- mode: conf -*-
            xwayland 1

            gaps inner 0
            gaps outer 0

            smart_gaps on

            font pango:terminus       10

            # remove border
            default_border            none
            smart_borders             on


            set  $backtick grave
            set  $MOD      Mod4
            set  $META     Mod1

            # reload sway config
            bindsym $META+$MOD+c reload
            bindsym $META+$MOD+r reload

            # launcher (app launcher)
            bindsym $MOD+d exec rofi -show combi

            # launcher (window switch)
            bindsym $MOD+$backtick exec rofi -show window

            # Alt+Tab window switching
            bindsym $MOD+Tab       focus right
            bindsym $MOD+Shift+Tab focus left

            bindsym $META+Return   fullscreen toggle

            bindsym $META+$MOD+f   floating toggle

            bindsym $MOD+1 [floating] move scratchpad
            bindsym $MOD+2 nop

            set $size_ppt 100

            bindsym $MOD+3 {
              [floating app_id=(?i)alacritty] scratchpad show;  [floating app_id=(?i)alacritty] resize set $size_ppt ppt $size_ppt ppt; [floating app_id=(?i)alacritty] move position center
            }
            bindsym $MOD+4 {
              [floating app_id=(?i)firefox] scratchpad show;  [floating app_id=(?i)firefox] resize set $size_ppt ppt $size_ppt ppt; [floating app_id=(?i)firefox] move position center
            }

            bindsym $MOD+5 nop
            bindsym $MOD+6 nop
            bindsym $MOD+7 nop

            # bindsym {
            #   $META+$MOD+p mark --toggle pin
            # }

            for_window [class=.*] floating enable
            for_window [app_id=.*] floating enable

            # text editor
            for_window [class=(?i)emacs] floating disable
            for_window [app_id=(?i)emacs] floating disable

            # terminal
            # [app_id=(?i)alacritty]

            # web browsers
            # [app_id=(?i)org.qutebrowser.qutebrowser]

            for_window [app_id=(?i)firefox|qutebrowser|microsoft.edge|alacritty] floating enable
            for_window [floating] move position center


            # bar {
            #     id top
            #     swaybar_command waybar

            #     # output eDP-1

            #     # # strip_workspace_numbers yes|no
            #     # strip_workspace_numbers yes

            #     # # strip_workspace_name yes|no
            #     # strip_workspace_name yes

            #     # position top

            #     # # mode hide
            #     # modifier $MOD
            # }


            input type:keyboard {
              xkb_options caps:hyper,grp:rctrl_toggle
              xkb_layout  us,no

              # default: 250
              repeat_delay 250

              # default: 45
              repeat_rate 20
            }


            input type:touchpad {
               dwt              enabled
               tap              enabled
               natural_scroll   enabled
               middle_emulation enabled

               # disable mouse acceleration (enabled by default; to set it manually, use

               # "adaptive" instead of "flat")
               accel_profile "flat"

               # set mouse sensitivity (between -1 and 1)
               pointer_accel 0.5
            }


            output {
                 eDP-1 {
                   scale 1.5
            #=====================WWWWxHHHH=====WWWW==HHHH===
                       resolution 1920x1080 pos    0     0
            #=====================WWWWxHHHH=====WWWW==HHHH===
                 }
            }


            include "chassis/$(hostnamectl chassis)/bindings"
            include "theme/default"
            include "font/*"

            exec_always --no-startup-id dbus-update-activation-environment --systemd WAYLAND_DISPLAY DBUS_SESSION_BUS_ADDRESS DISPLAY XAUTHORITY
            exec_always --no-startup-id dbus-update-activation-environment
            exec_always --no-startup-id systemd-run --user --unit=waybar2 waybar || systemctl --user restart waybar2


      - dotfile:
          name: rofi
          path: ~/.config/rofi/config.rasi
          content: |
            /* -*- mode: css -*- */
            @theme "theme.rasi"

            listview {
                lines: 8;
                scrollbar: false;
            }

            configuration {
              font: "San Francisco Display 20";
              show-icons: true;
              combi-modes: "poc,emacs,sway,clipboard,window,drun";
              combi-hide-mode-prefix: false;
              combi-hide-mode-prefix: true;
            }

            window {
                /* background-color: rgba(100, 100, 100, 100%); */
                close-on-delete: true;
                window-command: "gh _rofi_window_command";
                /* background-color: rgba(100, 100, 100, 100%); */
                /* background-color: var(bg-window); */
                background-color: var(bg-window);
                reverse: true;
            }

            timeout {
                action: "kb-cancel";
                delay:  0;
            }

            filebrowser {
                directories-first: true;
                sorting-method:    "name";
            }

            entry {
                text-color:        var(text-input);
                cursor:            text;
                spacing:           5;
                placeholder-color: Gray;
                placeholder:       "Type to filter";
            }

            inputbar {
                text-color: var(text-selection);
                padding:    1px ;
                spacing:    0px ;
                children:   var(input-items);
            }

            textbox {
                text-color:       var(text-normal);
            }

            element-icon {
                background-color: transparent;
                size:             1.5000em ;
                cursor:           inherit;
                text-color:       var(text-normal);
            }

            box {
                text-color:       var(text-normal);
            }

            element {
                text-color:       var(text-normal);
                padding: 7px ;
                cursor:  pointer;
                spacing: 5px ;
                border:  0;
            }

            element selected {
                text-color:       var(text-selection);
            }

            element normal.normal {
                text-color:       var(text-normal);
            }

            element normal.urgent {
                text-color:       var(text-normal);
            }

            element normal.active {
                text-color:       var(text-selection);
            }

            element selected.normal {
                text-color:       var(text-selection);
            }

            element selected.urgent {
                text-color:       var(text-selection);
            }

            element selected.active {
                text-color:       var(text-selection);
            }

            element alternate.normal {
                text-color:       var(text-normal);
            }

            element alternate.urgent {
                text-color:       var(text-normal);
            }

            element alternate.active {
                text-color:       var(text-normal);
            }

      - dotfile:
          name: gh
          path: ~/.config/gh/config.yml
          validate: 'yj -yj %s'
          content: |
            {{gh.config|to_yaml}}

      # - dotfile:
      #     name: alacritty
      #     path: ~/.config/alacritty/config.toml
      #     validate: 'yj -tj %s'
      #     content: |
      #       {{alacritty.config|toml}}

      - dotfile:
          name: waybar style.css
          path: ~/.config/waybar/style.css
          content: |
              @import "catppuccin/mocha.css";
              /* @import "catppuccin/themes/mocha.css"; */
              /* Use the colors in your Waybar style.css. Waybar uses GTK3 CSS. */

              * {
                  font-family: UbuntuSansMono Nerd Font Propo;
                  /* color: @text; */
                  /* color: @sapphire; */
                  /* color: @rosewater; */
                  /* color: @flamingo; */
                  /* color: @pink; */
                  /* color: @mauve; */
                  /* color: @red; */
                  /* color: @maroon; */
                  /* color: @peach; */
                  /* color: @yellow; */
                  /* color: @green; */
                  /* color: @teal; */
                  /* color: @sky; */
                  /* color: @sapphire; */
                  color: @blue;
                  /* color: @lavender; */
                  /* color: @text; */
                  /* color: @subtext1; */
                  /* color: @subtext0; */
                  /* color: @overlay2; */
                  /* color: @overlay1; */
                  /* color: @overlay0; */
                  /* color: @surface2; */
                  /* color: @surface1; */
                  /* color: @surface0; */
                  /* color: @base; */
                  /* color: @mantle; */
                  /* color: @crust; */

              }


      - system_file:
          path: /etc/NetworkManager/conf.d/tun.conf
          content: >-
            [keyfile]
            unmanaged-devices=interface-name:tun*

      - system_file:
          path: /etc/NetworkManager/conf.d/tailscale.conf
          content: >-
            [keyfile]
            unmanaged-devices=interface-name:tailscale*

      - system_file:
          path: /etc/NetworkManager/conf.d/wgpia.conf
          content: >-
            [keyfile]
            unmanaged-devices=interface-name:wgpia*dd

      - system_file:
          path: >-
            /etc/NetworkManager/dispatcher.d/99dns.sh
          mode: >-
            0750
          content: >-
            #!/usr/bin/env bash
            action_up() {
            case $DEVICE_IFACE in
            wlp*);;
            enp*);;
            wgpia*|tun*)
            # 10.0.0.242 - DNS
            # 10.0.0.243 - DNS+Streaming
            # 10.0.0.244 - DNS+MACE
            # 10.0.0.241 - DNS+Streaming+Mace
            install -DT -- /dev/stdin /etc/resolv.conf <<< 'nameserver 10.0.0.241'
            ;;
            esac
            }


            case ${NM_DISPATCHER_ACTION} in
            *up*) action_up
            ;;
            esac

    all_zsh_plugins:
      - 1password
      - aliases
      - alias-finder
      - ansible
      - ant
      - apache2-macports
      - arcanist
      - archlinux
      - arduino-cli
      - argocd
      - asdf
      - autoenv
      - autojump
      - autopep8
      - aws
      - azure
      - battery
      - bazel
      - bbedit
      - bedtools
      - bgnotify
      - bower
      - branch
      - brew
      - bridgetown
      - bun
      - bundler
      - cabal
      - cake
      - cakephp3
      - capistrano
      - cask
      - catimg
      - celery
      - charm
      - chruby
      - chucknorris
      - cloudfoundry
      - codeclimate
      - coffee
      - colemak
      - colored-man-pages
      - colorize
      - command-not-found
      - common-aliases
      - compleat
      - composer
      - conda-env
      - copybuffer
      - copyfile
      - copypath
      - cp
      - cpanm
      - dash
      - dbt
      - debian
      - deno
      - dircycle
      - direnv
      - dirhistory
      - dirpersist
      - dnf
      - dnote
      - docker
      - docker-compose
      - docker-machine
      - doctl
      - dotenv
      - dotnet
      - droplr
      - drush
      - eecms
      - emacs
      - ember-cli
      - emoji
      - emoji-clock
      - emotty
      - encode64
      - extract
      - eza
      - fabric
      - fancy-ctrl-z
      - fasd
      - fastfile
      - fbterm
      - fig
      - firewalld
      - flutter
      - fluxcd
      - fnm
      - forklift
      - fossil
      - frontend-search
      - fzf
      - gas
      - gatsby
      - gcloud
      - geeknote
      - gem
      - genpass
      - gh
      - git
      - git-auto-fetch
      - git-commit
      - git-escape-magic
      - git-extras
      - gitfast
      - git-flow
      - git-flow-avh
      - github
      - git-hubflow
      - gitignore
      - git-lfs
      - git-prompt
      - glassfish
      - globalias
      - gnu-utils
      - golang
      - gpg-agent
      - gradle
      - grails
      - grc
      - grunt
      - gulp
      - hanami
      - hasura
      - helm
      - heroku
      - heroku-alias
      - history
      - history-substring-search
      - hitchhiker
      - hitokoto
      - homestead
      - httpie
      - invoke
      - ionic
      - ipfs
      - isodate
      - istioctl
      - iterm2
      - jake-node
      - jenv
      - jfrog
      - jhbuild
      - jira
      - jruby
      - jsontools
      - juju
      - jump
      - kate
      - keychain
      - kind
      - kitchen
      - kitty
      - kn
      - knife
      - knife_ssh
      - kops
      - kubectl
      - kubectx
      - kube-ps1
      - lando
      - laravel
      - laravel4
      - laravel5
      - last-working-dir
      - lein
      - lighthouse
      - lol
      - lpass
      - lxd
      - macos
      - macports
      - magic-enter
      - man
      - marked2
      - marktext
      - mercurial
      - meteor
      - microk8s
      - minikube
      - mise
      - mix
      - mix-fast
      - mongo-atlas
      - mongocli
      - mosh
      - multipass
      - mvn
      - mysql-macports
      - n98-magerun
      - nanoc
      - nats
      - ng
      - nmap
      - node
      - nodenv
      - nomad
      - npm
      - nvm
      - oc
      - octozen
      - opentofu
      - operator-sdk
      - otp
      - pass
      - paver
      - pep8
      - percol
      - per-directory-history
      - perl
      - perms
      - phing
      - pip
      - pipenv
      - pj
      - please
      - pm2
      - pod
      - podman
      - poetry
      - poetry-env
      - postgres
      - pow
      - powder
      - powify
      - pre-commit
      - procs
      - profiles
      - pyenv
      - pylint
      - python
      - qodana
      - qrcode
      - rails
      - rake
      - rake-fast
      - rand-quote
      - rbenv
      - rbfu
      - rbw
      - react-native
      - rebar
      - redis-cli
      - repo
      - ros
      - rsync
      - ruby
      - rust
      - rvm
      - safe-paste
      - salt
      - samtools
      - sbt
      - scala
      - scd
      - screen
      - scw
      - sdk
      - sfdx
      - sfffe
      - shell-proxy
      - shrink-path
      - sigstore
      - singlechar
      - skaffold
      - snap
      - spring
      - sprunge
      - ssh
      - ssh-agent
      - stack
      - starship
      - stripe
      - sublime
      - sublime-merge
      - sudo
      - supervisor
      - suse
      - svcat
      - svn
      - svn-fast-info
      - swiftpm
      - symfony
      - symfony2
      - symfony6
      - systemadmin
      - systemd
      - taskwarrior
      - terminitor
      - term_tab
      - terraform
      - textastic
      - textmate
      - thefuck
      - themes
      - thor
      - tig
      - timer
      - tldr
      - tmux
      - tmux-cssh
      - tmuxinator
      - toolbox
      - torrent
      - transfer
      - tugboat
      - ubuntu
      - ufw
      - universalarchive
      - urltools
      - vagrant
      - vagrant-prompt
      - vault
      - vim-interaction
      - vi-mode
      - virtualenv
      - virtualenvwrapper
      - volta
      - vscode
      - vundle
      - wakeonlan
      - watson
      - wd
      - web-search
      - wp-cli
      - xcode
      - yarn
      - yii
      - yii2
      - yum
      - z
      - zbell
      - zeus
      - zoxide
      - zsh-interactive-cd
      - zsh-navigation-tools

    COMMENT: false

    alacritty:
      config:
        live_config_reload: true
        import:
          - ~/opt/catppuccin/alacritty/catppuccin-mocha.toml
        env:
          GDK_DPI_SCALE: "1.0"
          GDK_SCALE: "1.0"
          TERM: screen-256color
          SHELL: /bin/zsh
          LANG: en_US.UTF-8
          LC_ALL: nb_NO.UTF-8
        scrolling:
          history: 0
        window:
          opacity: 0.9
          dynamic_title: true
          padding:
            x: 10
            "y": 8
          position:
            x: 0
            "y": 0
        colors:
          transparent_background_colors: true
        cursor:
          style:
            blinking: Always
            shape: Block
        hints:
          enabled:
            - regex: '[^ ]+\.rs:\d+:\d+'
              command:
                program: xdg-open
              mouse:
                enabled: true
        keyboard:
          bindings:
            - action: SpawnNewInstance
              key: Return
              mods: Control|Shift
        font:
          size: 10.0
          bold:
            family: UbuntuSansMono Nerd Font
            style: Bold
          bold_italic:
            family: UbuntuSansMono Nerd Font
            style: Bold Italic
          italic:
            family: UbuntuSansMono Nerd Font
            style: Italic
          normal:
            family: UbuntuSansMono Nerd Font
            style: Regular


    gh:
      config:
        version: "1"

        # What protocol to use when performing git operations. Supported values: ssh, https
        git_protocol: https

        # What editor gh should run when creating issues, pull requests, etc. If blank, will refer to environment.
        editor: emacsclient

        # When to interactively prompt. This is a global config that cannot be overridden by hostname. Supported values: enabled, disabled
        prompt: enabled

        # A pager program to send command output to, e.g. "less". Set the value to "cat" to disable the pager.
        pager: /usr/bin/cat

        # Aliases allow you to create nicknames for gh commands

        # The path to a unix socket through which send HTTP connections. If blank, HTTP traffic will be handled by net/http.DefaultTransport.
        http_unix_socket:

        # What web browser gh should use when opening URLs. If blank, will refer to environment.
        browser: firefox

        aliases:
          co: pr checkout
          gists: gist ls
          repos: '!NO_COLOR=1 gh repo list --json nameWithOwner| jq -rcM ''.[][]'''
          transform.html.to.json: '!exec ~/go/bin/pup ''json{}'''
          transform.json.to.yml: '!exec yj -jy'
          transform.yaml.to.json: '!exec yj -yj'
          transform.json.to.toml: '!exec yj -jt'
          transform.toml.to.json: '!exec yj -tj'
          jq.append: '!exec jq ''{$ARGS.positional[0]:(.)}'' --args ${@:-data}'
          transform.json.to.pkl: '!VERSION=1.0.2; exec pkl eval package://pkg.pkl-lang.org/pkl-pantry/pkl.pipe@${VERSION}#/json.pkl -x "${@:-pipe}"'
          withTemporaryDirectory: |
            !declare TEXT
            if ! tty; then
              mapfile TEXT
              export TEXT
            fi

            command mktemp -d /dev/shm/.XXXXXXXXXXXX |
              while read -r pwd; do
                pushd "${pwd}" &>/dev/null
                export CURL_HOME="${PWD}"
                if [[ $@ ]]; then
                  env -C "${OLDPWD}" $@ | tee out
                else
                  tee out <<< "${TEXT[@]}"
                fi
                wc -l out
                pass insert --multiline last/text < out &>/dev/null
                case $(file -s out | tee /dev/stderr) in
                  *JSON*)
                    declare -x cmd=(pass insert --multiline)
                    declare -x yj=~/go/bin/yj

                    tee >(${cmd[@]} last/json) >($yj -jy|${cmd[@]} last/yaml) < out

                    read type < <(jq -r type < out)

                    cat out |
                      case "${type}"  in
                        array)  jo output:=- ;;
                        object) cat ;;
                      esac | tee >(
                              $yj -jt|${cmd[@]} last/toml
                            ) >(
                              gh transform.json.to.pkl|${cmd[@]} last/pkl
                            )
                    ;;
                  esac &>/dev/null
                # rm -rvf -- "${OLDPWD}"
                rm -rvf /dev/shm/.????????????
              done
            popd &>/dev/null
          withTemporaryFile: null
          html2json: '!exec ~/go/bin/pup ''json{}'''
          getPubclicIP: |
            !exec curl --silent 'https://ifconfig.co/json'
          first: '!exec head -n1 $@'
          last: '!exec tail -n1 $@'
          xcat: '!exec xargs cat'
          json2pkl: '!VERSION=1.0.2; URL=package://pkg.pkl-lang.org/pkl-pantry/pkl.pipe@${VERSION}#/json.pkl; exec pkl eval "$URL" -x "${@:-pipe}"'
          toml2pkl: '!yj -t | gh json2pkl "$@"'
          env: |
            !exec grep -Pi0z -- "${@:-.}" /proc/${PPID}/environ
          awk.env.var.names: |
            !set - ${PPID:-${$}}
            for PID; do
              awk 'BEGIN{RS="\0";ORS="\n";FS="=";}/^[[:upper:]_]+/{print $1}' /proc/${PID}/environ
            done
          _cfg_helper: |
            !set - ${HOME}/Projects/config
            echo -en "${1}"
            mkdir --parents -- "${_}"
            cd -- "${_}"
            if ! [ -d ${1} ]; then
              gh repo clone ${1##*/} || gh repo create --clone --private ${1##*/}
            fi &>/dev/null
            for i in $1/.git{config,ignore}; do
              if ! [ -f "$i" ]; then
                touch "$i"
              fi
            done
          cfg: |
            !${DEBUG:+set -x};
            # env --chdir=$(gh _cfg_helper)
            pushd -- $(gh _cfg_helper)
            export PAGER=cat
            git config --no-system --no-global --no-worktree --no-local --file .gitconfig "${@}"
          _debug_cmdline: |
            !set -x
            xargs -n1 -0a /proc/${PPID}/cmdline
          _helper_debug: |
            !# FIXME #
            jq -r '.aliases|with_entries(.key|startswith("_debug_"))'
          _debug: |
            !yj < ~/.config/gh/config.yml
          cfg.dump: |
            !gh cfg --get-all
          cfg.ls: '!gh cfg --get-all | grep -- "${@:-.}"'
          cfg.regex: '!gh cfg --get-regexp "${@:-.}"'
          with.homedir: '!exec /usr/bin/env --chdir="$HOME" "$@"'
          deleteme.zsh.rc.pre: |
            !cat <<'.zshrc_EOF'
            # exec 3<>/dev/null
            .zshrc_EOF
          deleteme.zsh.rc.post: |
            !cat <<'.zshrc_EOF'
            plugins=(fd fzf z zoxide git gh pass ripgrep docker)
            export ZSH="$HOME/.oh-my-zsh"
            ZSH_THEME="gentoo"
            alias -- cat='command ~/.cargo/bin/bat'
            zpath=($zpath ~/.local/share/zsh)
            .zshrc_EOF
          _debug_current_gh_script: |
            !set -x
            set | grep BASH
            # install -DT -- "$0" /tmp/current.sh
            # bat /tmp/current.sh
          example.systemd.socket.fifo: |
            !set -x
            dir=${XDG_RUNTIME_DIR}/example
            userdir=${HOME}/.config/systemd/user
            debugger="Activated '%%i: %i | %%I: %I | %%P: %P'"

            systemctl --user daemon-reload
            mkdir -pv -- "$dir"

            cat <<SOCKET_EOF | tee >(install -vDT /dev/stdin ~/.config/systemd/user/example.socket)
            [Socket]
            ListenFIFO=${rundir/${XDG_RUNTIME_DIR}/%t}/fifo
            SocketMode=0660

            [Install]
            WantedBy=sockets.target
            SOCKET_EOF

            cat <<SERVICE_EOF | tee >(install -vDT /dev/stdin ~/.config/systemd/user/example.service)
            [Service]
            Type=oneshot
            # ExecStart=xargs -0 notify-send "Example socket activated"
            ExecStart=cat
            StandardInput=socket
            StandardOutput=journal
            # Restart=no
            SERVICE_EOF

            systemctl --user daemon-reload
            systemctl --user enable example.{socket,service}
            systemctl --user start example.socket
            stat $rundir/example.sock
            tee "${_}" <<< foo
            systemctl --user disable --now example.socket
            systemctl --user stop example.socket
            rm -vf -- $userdir/example.* $rundir
            systemctl --user daemon-reload
          example.systemd.socket.unix: |
            !set -x
            mkdir -pv -- ${XDG_RUNTIME_DIR}/deleteme/
            cat <<SOCKET_EOF | tee >(install -vDT /dev/stdin ~/.config/systemd/user/example.socket)
            [Socket]
            ListenStream=%t/deleteme/example.sock
            SocketMode=0660

            [Install]
            WantedBy=sockets.target
            SOCKET_EOF

            cat <<SERVICE_EOF | tee >(install -vDT /dev/stdin ~/.config/systemd/user/example.service)
            [Service]
            Type=oneshot
            ExecStart=notify-send "Example socket" "Activated"
            Restart=no
            SERVICE_EOF
            systemctl --user daemon-reload
            systemctl --user enable --now example.socket
            stat ${XDG_RUNTIME_DIR}/deleteme/example.sock
            nc -U "${_}" <<< foo
            systemctl --user disable --now example.socket
          emacsclient: |
            !exec xargs -0 emacsclient --eval <<ELISP_EOF
            (with-temp-buffer (switch-to-buffer (window-buffer (nth 0 (window-list))))
              ${@:-(buffer-file-name)})
            ELISP_EOF
          run: |
            !systemd-run --user "$@"
          _jq_example_from_stackexchange: |-
            !`# https://unix.stackexchange.com/questions/561460/how-to-print-path-and-key-values-of-json-file` jq -r 'paths(scalars | true) as $p  |
              [
                ( [ $p[] | tostring ] | join(".") ), ( getpath($p) | tojson )
              ] |
              join(": ")'
          _WORK_IN_PROGESS_json_dict_navigator: |
            !
            pushd $(mktemp -d) &>/dev/null
            tee original.json current.json

            export FZF_DEFAULT_COMMAND="jq 'keys' < current.json"
            export FZF_DEFAULT_OPTS="--preview=\"jq '.{}' < current.json\""

            while read SELECTION ; do
              [[ $SELECTION ]] || break
              jq ".${SELECTION}" < current.json | tee >(sponge current.json) /dev/tty
            done < <(fzf)
          clean.empty.files: |
            exec rm -iv -- $(find -maxdepth 1 -type f -empty)
          pass: '!exec pass git ls-files -z | sed -zE ''s#\.gpg\n?#\n#g'''
          import-config-force: |-
            !exec realpath --relative-base=$HOME/ "$@" |
              rsync -av --files-from=- --relative -- "$HOME"/ ~/Projects/config/;
              notify-send "Config imported" "$@"
          import-config: |-
            !exec realpath --relative-base=$HOME/  "$@" |
              rsync --dry-run -av --files-from=- --relative -- "$HOME"/ ~/Projects/config/
          _rofi_window_command: '!DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/$(id -u)/bus WAYLAND_DISPLAY=wayland-1 notify-send "_rofi_window_command" "$@"'
          indent: |
            !eval sed -E 's#^#${@:-}#'
          ___: '!sed -E ''s/[[:space:]](copy|file|service)://'''

  pre_tasks:

    # - name: Retry combined with a loop
    #   uri:
    #     url: "https://{{ item }}.ansible.com"
    #     method: GET
    #   register: uri_output
    #   with_items:
    #   - "www"
    #   retries: 2
    #   delay: 1
    #   until: "uri_output.status == 200"

    - name: jq
      when: no
      vars:
        q: >-
          .[]|
            with_entries(.key == "{{item_type}}")|
            select(.)
      register: jq
      loop:
        - rpm
        - cargo
      loop_control:
        loop_var: item_type
      check_mode: no
      command:
        cmd: >-
          jq --raw-output --monochrome-output
          {{q}}
        stdin: >-
          {{items|to_json}}

    - when: COMMENT
      tags: always
      vars:
        q: >-
          [?rpm]
      debug:
        msg: >-
          {{items|json_query(q)}}

    - name: Git repos
      block:
      - set_fact:
          _git_repos: |
            ---
            {% for _dom, _sites in __git_repos.items() %}
            {% for _sitename, _user in _sites.items() %}
            {% for _username, _repositories in _user.items() %}
            {% for _reponame in _repositories %}
            {{ansible_user_dir}}/opt/{{_sitename}}/{{_username}}: https://{{_sitename}}.{{_dom}}/{{_username}}/{{_reponame}}.git
            {% endfor %}
            {% endfor %}
            {% endfor %}
            {% endfor %}
            ...

      - set_fact: git_repos="{{_git_repos|from_yaml}}"

    # - name: Cargo crates
    #   block:
    #   - set_fact:
    #       _crates: |
    #         ---
    #         ...

    # - name: >-
    #     add
    #   when: "script.exists == true"
    #   ansible.builtin.lineinfile:
    #     create: yes
    #     path: >-
    #       {{ansible_user_dir}}/.zshenv
    #     state: present
    #     line: >-
    #       path+=({{script_path}})
    #     validate: >-
    #       /bin/zsh -c "source %s"


    # - name: >-
    #     enable hardware acceleration for video playback
    #   <<: *become
    #   when: COMMENT
    #   ansible.builtin.yum:
    #     state: present
    #     name:
    #       - ffmpeg-free
    #       - libavcodec-free
    #       - mesa-va-drivers
    #       - libva-intel-hybrid-driver

...
