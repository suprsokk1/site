# -*- mode: yaml -*-
# TODO .mozilla/chrome/userChrome.css
---
- hosts: all
  gather_facts: no
  tasks:
    - ansible.builtin.dnf: name=cargo,python3-jmespath state=installed
      no_log: &no_log no
      become: yes
      connection: local
      delegate_to: localhost
      become_user: root

- hosts: all
  connection: local
  gather_facts: yes
  become: no
  environment:

    # Inhibit playbook lockup
    GIT_TERMINAL_PROMPT: 0

    # REVIEW Safe for other packages?
    CARGO_FEATURE_PCRE2: 1


  post_tasks:
    - name: TODO
      meta: noop
      vars:
        b: &become
          become: yes
          become_user: root
        c: &common
          register: res
          when: res is successfull

  tasks:

    - name: Catppuccin
      tags: git catppuccin
      with_dict: "{{git_repos}}"
      loop_control:
        loop_var: x
      git: dest={{x.key}} repo={{x.value}}

    - name: >-
        Install ripgrep with PCRE2 enabled
      when: COMMENT
      community.general.cargo:
        name: ripgrep
        state: present
      environment:
        CARGO_FEATURE_PCRE2: 1

    - name: >-
        Install packages
      block:
        - community.general.cargo:
            state: present
            name: "{{ items|json_query('[?crate].name')|default(omit) }}"

        - community.general.pipx:
            state: present
            name: "{{ items|json_query('[?egg].name')|default(omit)  }}"

      rescue:
        - meta: noop

    - service: name="{{item}}" state="started" enabled=yes
      loop: "{{ items|json_query('[?service].name')|default(omit) }}"

    - name: >-
        Set default editor
      loop_control:
        extended: true
        loop_var: line
      loop:
        - ""
        - "# default editor"
        - "EDITOR=emacsclient"
        - "export EDITOR"
      ansible.builtin.lineinfile:
        create: yes
        path: >-
          {{ansible_user_dir}}/.zshenv
        state: present
        insertafter: >-
          {{ansible_loop.previtem|default(omit)}}
        line: >-
          {{line}}
        validate: /bin/zsh -c source %s


    - name: >-
        ~/.zshrc
      vars:
        plugins:
          - git
          - fzf

      ansible.builtin.copy:
        backup: yes
        dest: >-
          {{ansible_user_dir}}/.zshrc
        content: |
          export ZSH="$HOME/.oh-my-zsh"
          ZSH_THEME="gentoo"
          DISABLE_UNTRACKED_FILES_DIRTY="true"
          FZF_DEFAULT_OPTS=' --exact --bind '\''ctrl-s:toggle-all'\'' --multi ' ; export FZF_DEFAULT_OPTS

          plugins=()
          {% for plugin in plugins %}
          plugins+=({{plugin}})
          {% endfor %}

          source $ZSH/oh-my-zsh.sh

    - name: >-
        Set host facts from a task
      set_fact:
        script_path: "{{ansible_user_dir}}/.script"

    - stat: path="{{script_path}}"
      no_log: yes
      register: script

    # - name: >-
    #     Add
    #   when: "script.exists == true"
    #   ansible.builtin.lineinfile:
    #     create: yes
    #     path: >-
    #       {{ansible_user_dir}}/.zshenv
    #     state: present
    #     line: >-
    #       path+=({{script_path}})
    #     validate: >-
    #       /bin/zsh -c "source %s"


    # - name: >-
    #     Enable hardware acceleration for video playback
    #   <<: *become
    #   when: COMMENT
    #   ansible.builtin.yum:
    #     state: present
    #     name:
    #       - ffmpeg-free
    #       - libavcodec-free
    #       - mesa-va-drivers
    #       - libva-intel-hybrid-driver

    - file: path={{ansible_user_dir}}/.local/share/catppuccin state=directory recurse=yes

    - name: >-
        Sets attributes of files
      copy:
        path: >-
          {{ansible_user_home}}/.config/waybar/style.css
        content: >-
          @import "themes/macchiato.css";

    # - name: >-
    #     Add common paths to users zshenv
    #   loop_control:
    #     extended: true
    #     loop_var: path
    #   with_fileglob:
    #     - {{ansible_user_dir}}/*/bin
    #     - {{ansible_user_dir}}/.*/bin
    #     - {{ansible_user_dir}}/.local/share/pipx/venvs/*/bin
    #     - {{ansible_user_dir}}/.emacs.d/bin
    #     - {{ansible_user_dir}}/bin
    #   ansible.builtin.lineinfile:
    #     create: yes
    #     path: >-
    #       {{ansible_user_dir}}/.zshenv
    #     state: present
    #     insertafter: >-
    #       ^path+=({{ansible_loop.previtem|default(omit)}})
    #     line: >-
    #       path+=({{path}})
    #     validate: /bin/zsh -c source %s


  vars:
    __git_repos:
      com:
        github:
          catppuccin: [dunst,emacs,alacritty,sway,waybar]

    items:
      # - file:
      #     name:
      #     content: >-

      - shell_alias:
          name: ls
          command: 'command exa'

      - shell_alias:
          name: ls
          command: 'command lsd'

      - statusbar_module:
          TODO:

      - fzf:
          env: >-
            FZF_DEFAULT_COMMAND='fd --type f --hidden --exclude .git'
            FZF_DEFAULT_OPTS=' --reverse --exact --bind '\''ctrl-s:toggle-all'\'' --multi '

            FZF_LINES           Number of lines fzf takes up excluding padding and margin
            FZF_COLUMNS         Number of columns fzf takes up excluding padding and margin
            FZF_TOTAL_COUNT     Total number of items
            FZF_MATCH_COUNT     Number of matched items
            FZF_SELECT_COUNT    Number of selected items
            FZF_POS             Vertical position of the cursor in the list starting from 1
            FZF_QUERY           Current query string
            FZF_PROMPT          Prompt string
            FZF_PREVIEW_LABEL   Preview label string
            FZF_BORDER_LABEL    Border label string
            FZF_ACTION          The name of the last action performed
            FZF_KEY             The name of the last key pressed
            FZF_PORT            Port number when --listen option is used

            The following variables are additionally exported to the preview commands.

            FZF_PREVIEW_TOP     Top position of the preview window
            FZF_PREVIEW_LEFT    Left position of the preview window
            FZF_PREVIEW_LINES   Number of lines in the preview window
            FZF_PREVIEW_COLUMNS Number of columns in the preview window
      - service:
          name: ydotool

      - rpm:
          name: tldr
      - rpm:
          name: ydotool
      - rpm:
          name: NetworkManager-tui
      - rpm:
          name: ShellCheck
      - rpm:
          name: aajohan-comfortaa-fonts
      - rpm:
          name: alacritty
      - rpm:
          name: anaconda
      - rpm:
          name: anaconda-live
      - rpm:
          name: ansible
      - rpm:
          name: ansifilter
      - rpm:
          name: arm-image-installer
      - rpm:
          name: atk-devel
      - rpm:
          name: audispd-plugins
      - rpm:
          name: autoconf
      - rpm:
          name: blueman
      - rpm:
          name: borgbackup
      - rpm:
          name: brightnessctl
      - rpm:
          name: btop
      - rpm:
          name: cairo-devel
      - rpm:
          name: cargo
      - rpm:
          name: chromium
      - rpm:
          name: clang16-resource-filesystem
      - rpm:
          name: cmake
      - rpm:
          name: cronie
      - rpm:
          name: dbus-devel
      - rpm:
          name: ddgr
      - rpm:
          name: dialog
      - rpm:
          name: direnv
      - rpm:
          name: docker-compose
      - rpm:
          name: dracut-live
      - rpm:
          name: editorconfig
      - rpm:
          name: emacs
      - rpm:
          name: etckeeper
      - rpm:
          name: expect
      - rpm:
          name: fd-find
      - rpm:
          name: ffmpeg
      - rpm:
          name: fontconfig-devel
      - rpm:
          name: freerdp
      - rpm:
          name: freetype-devel
      - rpm:
          name: fswatch
      - rpm:
          name: fzf
      - rpm:
          name: gammastep
      - rpm:
          name: gh
      - rpm:
          name: ghostscript-tools-fonts
      - rpm:
          name: ghostscript-tools-printing
      - rpm:
          name: giflib-devel
      - rpm:
          name: git-delta
      - rpm:
          name: gnutls-devel
      - rpm:
          name: golang
      - rpm:
          name: gparted
      - rpm:
          name: gpm-devel
      - rpm:
          name: gron
      - rpm:
          name: gstreamer1-plugins-bad-free-extras
      - rpm:
          name: gstreamer1-plugins-bad-free-fluidsynth
      - rpm:
          name: gstreamer1-plugins-bad-free-opencv
      - rpm:
          name: gstreamer1-plugins-bad-free-wildmidi
      - rpm:
          name: gstreamer1-plugins-bad-free-zbar
      - rpm:
          name: gstreamer1-plugins-bad-freeworld
      - rpm:
          name: gstreamer1-plugins-good-extras
      - rpm:
          name: gtk3-devel
      - rpm:
          name: harfbuzz-devel
      - rpm:
          name: incron
      - rpm:
          name: intel-media-driver
      - rpm:
          name: jansson-devel
      - rpm:
          name: jc
      - rpm:
          name: jo
      - rpm:
          name: kitty
      - rpm:
          name: langpacks-en
      - rpm:
          name: libX11-devel
      - rpm:
          name: libXau-devel
      - rpm:
          name: libXdmcp-devel
      - rpm:
          name: libXi-devel
      - rpm:
          name: libXpm-devel
      - rpm:
          name: libXrender-devel
      - rpm:
          name: libXt-devel
      - rpm:
          name: libacl-devel
      - rpm:
          name: libgccjit-devel
      - rpm:
          name: libjpeg-turbo-devel
      - rpm:
          name: liblockfile-devel
      - rpm:
          name: libnsl
      - rpm:
          name: libotf-devel
      - rpm:
          name: libpng-devel
      - rpm:
          name: libreswan
      - rpm:
          name: librsvg2-devel
      - rpm:
          name: libselinux-devel
      - rpm:
          name: libsqlite3x-devel
      - rpm:
          name: libtiff-devel
      - rpm:
          name: libtree-sitter-devel
      - rpm:
          name: libva-intel-hybrid-driver
      - rpm:
          name: libva-utils
      - rpm:
          name: libwebp-devel
      - rpm:
          name: libxml2-devel
      - rpm:
          name: livesys-scripts
      - rpm:
          name: m17n-lib-devel
      - rpm:
          name: moby-engine
      - rpm:
          name: moreutils
      - rpm:
          name: ncurses-devel
      - rpm:
          name: nmap
      - rpm:
          name: nnn
      - rpm:
          name: nodejs
      - rpm:
          name: nodejs-bash-language-server
      - rpm:
          name: openscap
      - rpm:
          name: openscap-utils
      - rpm:
          name: openssh-askpass
      - rpm:
          name: pandoc
      - rpm:
          name: pass
      - rpm:
          name: pavucontrol
      - rpm:
          name: pinentry-emacs
      - rpm:
          name: pinentry-qt
      - rpm:
          name: pinentry-tty
      - rpm:
          name: pipx
      - rpm:
          name: powertop
      - rpm:
          name: python3-ansible-lint
      - rpm:
          name: python3-jmespath
      - rpm:
          name: python3-pip
      - rpm:
          name: python3-qrcode
      - rpm:
          name: qutebrowser
      - rpm:
          name: rclone
      - rpm:
          name: ripgrep
      - rpm:
          name: rofi-wayland
      - rpm:
          name: rpmfusion-free-release
      - rpm:
          name: rpmfusion-nonfree-release
      - rpm:
          name: scap-security-guide
      - rpm:
          name: scap-workbench
      - rpm:
          name: stow
      - rpm:
          name: systemd-devel
      - rpm:
          name: tailscale
      - rpm:
          name: texinfo
      - rpm:
          name: timeshift
      - rpm:
          name: tlp
      - rpm:
          name: tmux
      - rpm:
          name: vim-enhanced
      - rpm:
          name: webkit2gtk4.1-devel
      - rpm:
          name: wlsunset
      - rpm:
          name: xorg-x11-proto-devel
      - rpm:
          name: xz-lzma-compat
      - rpm:
          name: ydotool
      - rpm:
          name: kitty
      - rpm:
          name: alacritty
      - rpm:
          name: zlib-ng-compat-devel
      - rpm:
          name: zsh

      - crate:
          name: grex
      - crate:
          name: fd-find
      - crate:
          name: zoxide
      - crate:
          name: git-delta
      - crate:
          name: lsd
      - crate:
          name: topgrade
      - crate:
          name: bat


      - rpm:
          name: qutebrowser
      - rpm:
          name: rclone
      - rpm:
          name: ripgrep
      - rpm:
          name: rofi-wayland
      - rpm:
          name: rpmfusion-free-release
      - rpm:
          name: rpmfusion-nonfree-release
      - rpm:
          name: scap-security-guide
      - rpm:
          name: scap-workbench
      - rpm:
          name: stow
      - rpm:
          name: systemd
      - rpm:
          name: tailscale
      - rpm:
          name: texinfo
      - rpm:
          name: timeshift
      - rpm:
          name: tlp
      - rpm:
          name: tmux
      - rpm:
          name: vim-enhanced
      - rpm:
          name: webkit2gtk4.1
      - rpm:
          name: wlsunset
      - rpm:
          name: ydotool
      - rpm:
          name: zlib-ng-compat
      - rpm:
          name: zsh

      - zsh_plugin:
          name: zsh-autosuggestions     # sourced at end of ~/.zshrc
          source: git
      - zsh_plugin:
          name: ansible
      - zsh_plugin:
          name: docker
      - zsh_plugin:
          name: emacs
      - zsh_plugin:
          name: emacs-cli
      - zsh_plugin:
          name: fd
      - zsh_plugin:
          name: fzf
      - zsh_plugin:
          name: gh
      - zsh_plugin:
          name: git
      - zsh_plugin:
          name: pass
      - zsh_plugin:
          name: ripgrep
      - zsh_plugin:
          name: ssh
      - zsh_plugin:
          name: ssh-agent
      - zsh_plugin:
          name: z
      - zsh_plugin:
          name: zoxide


      - config_file:
          name: rofi
          content: |
            # -*- mode: conf -*-
            xwayland 1

            gaps inner 0
            gaps outer 0

            smart_gaps on

            font pango:terminus       10

            # remove border
            default_border            none
            smart_borders             on


            set  $backtick grave
            set  $MOD      Mod4
            set  $META     Mod1

            # reload sway config
            bindsym $META+$MOD+c reload
            bindsym $META+$MOD+r reload

            # launcher (app launcher)
            bindsym $MOD+d exec rofi -show combi

            # launcher (window switch)
            bindsym $MOD+$backtick exec rofi -show window

            # Alt+Tab window switching
            bindsym $MOD+Tab       focus right
            bindsym $MOD+Shift+Tab focus left

            bindsym $META+Return   fullscreen toggle

            bindsym $META+$MOD+f   floating toggle

            bindsym $MOD+1 [floating] move scratchpad
            bindsym $MOD+2 nop

            set $size_ppt 100

            bindsym $MOD+3 {
              [floating app_id=(?i)alacritty] scratchpad show;  [floating app_id=(?i)alacritty] resize set $size_ppt ppt $size_ppt ppt; [floating app_id=(?i)alacritty] move position center
            }
            bindsym $MOD+4 {
              [floating app_id=(?i)firefox] scratchpad show;  [floating app_id=(?i)firefox] resize set $size_ppt ppt $size_ppt ppt; [floating app_id=(?i)firefox] move position center
            }

            bindsym $MOD+5 nop
            bindsym $MOD+6 nop
            bindsym $MOD+7 nop

            # bindsym {
            #   $META+$MOD+p mark --toggle pin
            # }

            for_window [class=.*] floating enable
            for_window [app_id=.*] floating enable

            # text editor
            for_window [class=(?i)emacs] floating disable
            for_window [app_id=(?i)emacs] floating disable

            # terminal
            # [app_id=(?i)alacritty]

            # web browsers
            # [app_id=(?i)org.qutebrowser.qutebrowser]

            for_window [app_id=(?i)firefox|qutebrowser|microsoft.edge|alacritty] floating enable
            for_window [floating] move position center


            # bar {
            #     id top
            #     swaybar_command waybar

            #     # output eDP-1

            #     # # strip_workspace_numbers yes|no
            #     # strip_workspace_numbers yes

            #     # # strip_workspace_name yes|no
            #     # strip_workspace_name yes

            #     # position top

            #     # # mode hide
            #     # modifier $MOD
            # }


            input type:keyboard {
              xkb_options caps:hyper,grp:rctrl_toggle
              xkb_layout  us,no

              # default: 250
              repeat_delay 250

              # default: 45
              repeat_rate 20
            }


            input type:touchpad {
               dwt              enabled
               tap              enabled
               natural_scroll   enabled
               middle_emulation enabled

               # disable mouse acceleration (enabled by default; to set it manually, use

               # "adaptive" instead of "flat")
               accel_profile "flat"

               # set mouse sensitivity (between -1 and 1)
               pointer_accel 0.5
            }


            output {
                 eDP-1 {
                   scale 1.5
            #=====================WWWWxHHHH=====WWWW==HHHH===
                       resolution 1920x1080 pos    0     0
            #=====================WWWWxHHHH=====WWWW==HHHH===
                 }
            }


            include "chassis/$(hostnamectl chassis)/bindings"
            include "theme/default"
            include "font/*"

            exec_always --no-startup-id dbus-update-activation-environment --systemd WAYLAND_DISPLAY DBUS_SESSION_BUS_ADDRESS DISPLAY XAUTHORITY
            exec_always --no-startup-id dbus-update-activation-environment
            exec_always --no-startup-id systemd-run --user --unit=waybar2 waybar || systemctl --user restart waybar2


      - config_file:
          name: rofi
          path: ~/.config/rofi/config.rasi
          content: |
            /* -*- mode: css -*- */
            @theme "theme.rasi"

            listview {
                lines: 8;
                scrollbar: false;
            }

            configuration {
              font: "San Francisco Display 20";
              show-icons: true;
              combi-modes: "poc,emacs,sway,clipboard,window,drun";
              {{# combi-display-format: "{text}";  #}}
              {{# combi-display-format: "{mode} {text}";  #}}
              combi-hide-mode-prefix: false;
              combi-hide-mode-prefix: true;
              {{# modes: "window,drun,run,ssh"; #}}
              {{# sidebar-mode: false; #}}
              {{# combi-display-format: "{mode} {text}"; #}}
              {{# completer-mode: "recursivebrowser"; #}}
              {{# kb-mode-next: "Shift+Right,Control+Tab"; #}}
              {{# kb-mode-previous: "Shift+Left,Control+ISO_Left_Tab"; #}}
              {{# kb-mode-complete: "Control+l"; #}}
              {{# font: "Hack 20";  #}}
              {{# font-size: 30;  #}}
              {{# show-icons: false;  #}}
              {{# icon-theme: "Papirus";  #}}
              {{# scrollbar:  false;  #}}

            }

            window {
                /* background-color: rgba(100, 100, 100, 100%); */
                close-on-delete: true;
                window-command: "gh _rofi_window_command";
                /* background-color: rgba(100, 100, 100, 100%); */
                /* background-color: var(bg-window); */
                background-color: var(bg-window);
                reverse: true;
            }

            timeout {
                action: "kb-cancel";
                delay:  0;
            }

            filebrowser {
                directories-first: true;
                sorting-method:    "name";
            }

            entry {
                text-color:        var(text-input);
                cursor:            text;
                spacing:           5;
                placeholder-color: Gray;
                placeholder:       "Type to filter";
            }

            inputbar {
                text-color: var(text-selection);
                padding:    1px ;
                spacing:    0px ;
                children:   var(input-items);
            }

            textbox {
                text-color:       var(text-normal);
            }

            element-icon {
                background-color: transparent;
                size:             1.5000em ;
                cursor:           inherit;
                text-color:       var(text-normal);
            }

            box {
                text-color:       var(text-normal);
            }

            element {
                text-color:       var(text-normal);
                padding: 7px ;
                cursor:  pointer;
                spacing: 5px ;
                border:  0;
            }

            element selected {
                text-color:       var(text-selection);
            }

            element normal.normal {
                text-color:       var(text-normal);
            }

            element normal.urgent {
                text-color:       var(text-normal);
            }

            element normal.active {
                text-color:       var(text-selection);
            }

            element selected.normal {
                text-color:       var(text-selection);
            }

            element selected.urgent {
                text-color:       var(text-selection);
            }

            element selected.active {
                text-color:       var(text-selection);
            }

            element alternate.normal {
                text-color:       var(text-normal);
            }

            element alternate.urgent {
                text-color:       var(text-normal);
            }

            element alternate.active {
                text-color:       var(text-normal);
            }

      - file:
          path: /etc/NetworkManager/conf.d/tun.conf
          content: >-
            [keyfile]
            unmanaged-devices=interface-name:tun*

      - file:
          path: /etc/NetworkManager/conf.d/tailscale.conf
          content: >-
            [keyfile]
            unmanaged-devices=interface-name:tailscale*

      - file:
          path: /etc/NetworkManager/conf.d/wgpia.conf
          content: >-
            [keyfile]
            unmanaged-devices=interface-name:wgpia*dd

      - file:
          path: >-
            /etc/NetworkManager/dispatcher.d/99dns.sh
          mode: >-
            0750
          content: >-
            #!/usr/bin/env bash
            action_up() {
            case $DEVICE_IFACE in
            wlp*);;
            enp*);;
            wgpia*|tun*)
            # 10.0.0.242 - DNS
            # 10.0.0.243 - DNS+Streaming
            # 10.0.0.244 - DNS+MACE
            # 10.0.0.241 - DNS+Streaming+Mace
            install -DT -- /dev/stdin /etc/resolv.conf <<< 'nameserver 10.0.0.241'
            ;;
            esac
            }


            case ${NM_DISPATCHER_ACTION} in
            *up*) action_up
            ;;
            esac



    all_zsh_plugins:
      - 1password
      - aliases
      - alias-finder
      - ansible
      - ant
      - apache2-macports
      - arcanist
      - archlinux
      - arduino-cli
      - argocd
      - asdf
      - autoenv
      - autojump
      - autopep8
      - aws
      - azure
      - battery
      - bazel
      - bbedit
      - bedtools
      - bgnotify
      - bower
      - branch
      - brew
      - bridgetown
      - bun
      - bundler
      - cabal
      - cake
      - cakephp3
      - capistrano
      - cask
      - catimg
      - celery
      - charm
      - chruby
      - chucknorris
      - cloudfoundry
      - codeclimate
      - coffee
      - colemak
      - colored-man-pages
      - colorize
      - command-not-found
      - common-aliases
      - compleat
      - composer
      - conda-env
      - copybuffer
      - copyfile
      - copypath
      - cp
      - cpanm
      - dash
      - dbt
      - debian
      - deno
      - dircycle
      - direnv
      - dirhistory
      - dirpersist
      - dnf
      - dnote
      - docker
      - docker-compose
      - docker-machine
      - doctl
      - dotenv
      - dotnet
      - droplr
      - drush
      - eecms
      - emacs
      - ember-cli
      - emoji
      - emoji-clock
      - emotty
      - encode64
      - extract
      - eza
      - fabric
      - fancy-ctrl-z
      - fasd
      - fastfile
      - fbterm
      - fig
      - firewalld
      - flutter
      - fluxcd
      - fnm
      - forklift
      - fossil
      - frontend-search
      - fzf
      - gas
      - gatsby
      - gcloud
      - geeknote
      - gem
      - genpass
      - gh
      - git
      - git-auto-fetch
      - git-commit
      - git-escape-magic
      - git-extras
      - gitfast
      - git-flow
      - git-flow-avh
      - github
      - git-hubflow
      - gitignore
      - git-lfs
      - git-prompt
      - glassfish
      - globalias
      - gnu-utils
      - golang
      - gpg-agent
      - gradle
      - grails
      - grc
      - grunt
      - gulp
      - hanami
      - hasura
      - helm
      - heroku
      - heroku-alias
      - history
      - history-substring-search
      - hitchhiker
      - hitokoto
      - homestead
      - httpie
      - invoke
      - ionic
      - ipfs
      - isodate
      - istioctl
      - iterm2
      - jake-node
      - jenv
      - jfrog
      - jhbuild
      - jira
      - jruby
      - jsontools
      - juju
      - jump
      - kate
      - keychain
      - kind
      - kitchen
      - kitty
      - kn
      - knife
      - knife_ssh
      - kops
      - kubectl
      - kubectx
      - kube-ps1
      - lando
      - laravel
      - laravel4
      - laravel5
      - last-working-dir
      - lein
      - lighthouse
      - lol
      - lpass
      - lxd
      - macos
      - macports
      - magic-enter
      - man
      - marked2
      - marktext
      - mercurial
      - meteor
      - microk8s
      - minikube
      - mise
      - mix
      - mix-fast
      - mongo-atlas
      - mongocli
      - mosh
      - multipass
      - mvn
      - mysql-macports
      - n98-magerun
      - nanoc
      - nats
      - ng
      - nmap
      - node
      - nodenv
      - nomad
      - npm
      - nvm
      - oc
      - octozen
      - opentofu
      - operator-sdk
      - otp
      - pass
      - paver
      - pep8
      - percol
      - per-directory-history
      - perl
      - perms
      - phing
      - pip
      - pipenv
      - pj
      - please
      - pm2
      - pod
      - podman
      - poetry
      - poetry-env
      - postgres
      - pow
      - powder
      - powify
      - pre-commit
      - procs
      - profiles
      - pyenv
      - pylint
      - python
      - qodana
      - qrcode
      - rails
      - rake
      - rake-fast
      - rand-quote
      - rbenv
      - rbfu
      - rbw
      - react-native
      - rebar
      - redis-cli
      - repo
      - ros
      - rsync
      - ruby
      - rust
      - rvm
      - safe-paste
      - salt
      - samtools
      - sbt
      - scala
      - scd
      - screen
      - scw
      - sdk
      - sfdx
      - sfffe
      - shell-proxy
      - shrink-path
      - sigstore
      - singlechar
      - skaffold
      - snap
      - spring
      - sprunge
      - ssh
      - ssh-agent
      - stack
      - starship
      - stripe
      - sublime
      - sublime-merge
      - sudo
      - supervisor
      - suse
      - svcat
      - svn
      - svn-fast-info
      - swiftpm
      - symfony
      - symfony2
      - symfony6
      - systemadmin
      - systemd
      - taskwarrior
      - terminitor
      - term_tab
      - terraform
      - textastic
      - textmate
      - thefuck
      - themes
      - thor
      - tig
      - timer
      - tldr
      - tmux
      - tmux-cssh
      - tmuxinator
      - toolbox
      - torrent
      - transfer
      - tugboat
      - ubuntu
      - ufw
      - universalarchive
      - urltools
      - vagrant
      - vagrant-prompt
      - vault
      - vim-interaction
      - vi-mode
      - virtualenv
      - virtualenvwrapper
      - volta
      - vscode
      - vundle
      - wakeonlan
      - watson
      - wd
      - web-search
      - wp-cli
      - xcode
      - yarn
      - yii
      - yii2
      - yum
      - z
      - zbell
      - zeus
      - zoxide
      - zsh-interactive-cd
      - zsh-navigation-tools

    COMMENT: false

  pre_tasks:

    # - name: Retry combined with a loop
    #   uri:
    #     url: "https://{{ item }}.ansible.com"
    #     method: GET
    #   register: uri_output
    #   with_items:
    #   - "www"
    #   retries: 2
    #   delay: 1
    #   until: "uri_output.status == 200"

    - name: jq
      when: no
      vars:
        q: >-
          .[]|
            with_entries(.key == "{{item_type}}")|
            select(.)
      register: jq
      loop:
        - rpm
        - cargo
      loop_control:
        loop_var: item_type
      check_mode: no
      no_log: *no_log
      command:
        cmd: >-
          jq --raw-output --monochrome-output
          {{q}}
        stdin: >-
          {{items|to_json}}

    - when: COMMENT
      tags: always
      vars:
        q: >-
          [?rpm]
      debug:
        msg: >-
          {{items|json_query(q)}}

    - name: Git repos
      no_log: *no_log
      block:
      - set_fact:
          _git_repos: |
            ---
            {% for _dom, _sites in __git_repos.items() %}
            {% for _sitename, _user in _sites.items() %}
            {% for _username, _repositories in _user.items() %}
            {% for _reponame in _repositories %}
            {{ansible_user_dir}}/opt/{{_sitename}}/{{_username}}: https://{{_sitename}}.{{_dom}}/{{_username}}/{{_reponame}}.git
            {% endfor %}
            {% endfor %}
            {% endfor %}
            {% endfor %}
            ...

      - set_fact: git_repos="{{_git_repos|from_yaml}}"

    # - name: Cargo crates
    #   block:
    #   - set_fact:
    #       _crates: |
    #         ---
    #         ...

...
